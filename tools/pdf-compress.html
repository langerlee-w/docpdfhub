<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <title data-i18n="tool.compress.ogTitle">Compress PDF — DocPDFHub</title>
  <meta name="description" content="" data-i18n="tool.compress.ogDesc"/>
  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css"/>
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet"/>

  <!-- libs -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

  <script src="/js/i18n.js" defer></script>
  <style>
    .gradient{background:linear-gradient(90deg,#d53369 0%,#daae51 100%)}
    .drop-active{outline:2px dashed #ec4899; outline-offset:6px; background:#fff7fb}
  </style>
</head>
<body class="text-gray-900 bg-gray-50" style="font-family:'Source Sans Pro',sans-serif;">
  <nav class="fixed w-full z-30 top-0 bg-white shadow">
    <div class="w-full max-w-6xl mx-auto flex items-center justify-between px-4 py-3">
      <a class="text-pink-600 font-extrabold text-2xl" href="/"><span data-i18n="common.brand">DocPDFHub</span></a>
      <div class="flex items-center space-x-2">
        <a href="/" class="text-sm text-gray-700 hover:text-pink-600" data-i18n="nav.home">Home</a>
        <span class="text-gray-300">|</span>
        <button data-lang-btn="en" class="px-2 py-1 rounded hover:bg-gray-100">EN</button>
        <button data-lang-btn="zh" class="px-2 py-1 rounded hover:bg-gray-100">中文</button>
      </div>
    </div>
  </nav>

  <header class="gradient text-white pt-28 pb-10">
    <div class="max-w-6xl mx-auto px-4">
      <p class="uppercase tracking-widest opacity-90 text-sm" data-i18n="home.hero_kicker">PDF TOOLS</p>
      <h1 class="text-4xl md:text-5xl font-extrabold mt-2" data-i18n="tool.compress.hero.title">Compress PDF</h1>
      <p class="text-white text-opacity-90 mt-2 md:w-3/4" data-i18n="tool.compress.hero.subtitle">
        Reduce size for easier sharing — kept fully local.
      </p>
      <p class="mt-3 text-sm text-white text-opacity-80" data-i18n="common.100_local">100% local in your browser • No upload</p>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    <div id="dropZone" class="bg-white border rounded-xl p-6 shadow-sm">
      <div class="text-center">
        <h2 class="text-xl font-bold" data-i18n="tool.compress.drop.title">Drop a PDF to compress</h2>
        <p class="text-gray-600 mt-1" data-i18n="tool.compress.drop.hint">Tip: choose a stronger level for email-friendly size.</p>

        <input id="fileInput" type="file" accept="application/pdf" class="hidden"/>
        <div class="mt-4">
          <button id="chooseBtn" class="bg-pink-600 text-white font-semibold rounded-full py-2 px-5 hover:bg-pink-700"
            data-i18n="tool.compress.drop.button">Select PDF</button>
          <div class="text-xs text-gray-500 mt-2" data-i18n="common.or_drop">or drag & drop</div>
        </div>
      </div>

      <div id="fileInfo" class="mt-6 hidden">
        <div class="flex items-center justify-between">
          <div>
            <div id="fileName" class="font-medium"></div>
            <div id="fileSize" class="text-xs text-gray-500"></div>
          </div>
          <button id="replaceBtn" class="text-sm px-3 py-1 rounded border hover:bg-gray-50" data-i18n="tool.compress.options.add_more">Replace file</button>
        </div>

        <div class="grid md:grid-cols-3 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="tool.compress.options.level">Compression level</label>
            <select id="level" class="w-full border rounded px-3 py-2">
              <option value="light" data-i18n="tool.compress.options.level_light">Light (best quality)</option>
              <option value="balanced" data-i18n="tool.compress.options.level_balanced">Balanced</option>
              <option value="strong" data-i18n="tool.compress.options.level_strong">Strong (smallest size)</option>
            </select>
          </div>
          <label class="flex items-center space-x-2">
            <input id="reduceImages" type="checkbox" class="form-checkbox h-4 w-4" checked/>
            <span class="text-sm" data-i18n="tool.compress.options.reduce_images">Downsample images</span>
          </label>
          <label class="flex items-center space-x-2">
            <input id="removeMeta" type="checkbox" class="form-checkbox h-4 w-4" checked/>
            <span class="text-sm" data-i18n="tool.compress.options.remove_metadata">Remove metadata</span>
          </label>
        </div>

        <div class="mt-6">
          <button id="runBtn" class="bg-pink-600 text-white font-bold rounded-full py-2.5 px-6" data-i18n="tool.compress.hero.primary_cta">Add PDF to Compress</button>
          <p id="runMsg" class="mt-2 text-sm text-gray-500 hidden"><span data-i18n="tool.compress.running.status">Compressing…</span>
            <span class="ml-1" data-i18n="tool.compress.running.tip">Your file never leaves your device.</span>
          </p>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-8 border-t text-center text-sm text-gray-500">
    <div class="max-w-6xl mx-auto px-4"><div data-i18n="footer.tagline">Free & private PDF tools in your browser.</div></div>
  </footer>

  <script>
  // pdf.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

  document.addEventListener('DOMContentLoaded', () => {
    const lang = localStorage.getItem('lang') || 'en';
    window.__i18n__?.setLang(lang);
  });
  document.querySelectorAll('[data-lang-btn]').forEach(btn=>{
    btn.addEventListener('click', ()=> window.__i18n__?.setLang(btn.getAttribute('data-lang-btn')));
  });

  const $ = s=>document.querySelector(s);
  const fmtBytes = (n)=>{const u=['B','KB','MB','GB'];let i=0;while(n>=1024&&i<u.length-1){n/=1024;i++}return n.toFixed(n<10&&i?1:0)+' '+u[i];}

  const dropZone = document.getElementById('dropZone');
  const fileInput = $('#fileInput'); const chooseBtn = $('#chooseBtn'); const replaceBtn = $('#replaceBtn');
  const fileInfo = $('#fileInfo'); const fileName=$('#fileName'); const fileSize=$('#fileSize');
  const level = $('#level'); const reduceImages=$('#reduceImages'); const removeMeta=$('#removeMeta');
  const runBtn = $('#runBtn'); const runMsg = $('#runMsg');

  let file = null;

  function showInfo(){
    fileInfo.classList.toggle('hidden', !file);
    if(file){ fileName.textContent=file.name; fileSize.textContent=fmtBytes(file.size); }
  }

  ;['dragenter','dragover'].forEach(evt=>{
    dropZone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drop-active'); });
  });
  ;['dragleave','drop'].forEach(evt=>{
    dropZone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drop-active'); });
  });
  dropZone.addEventListener('drop', (e)=>{
    const fs = Array.from(e.dataTransfer.files||[]).filter(f=>/pdf$/i.test(f.name));
    if (fs[0]){ file = fs[0]; showInfo(); }
  });

  fileInput.addEventListener('change', ()=>{
    const fs = Array.from(fileInput.files||[]).filter(f=>/pdf$/i.test(f.name));
    if (fs[0]){ file = fs[0]; showInfo(); }
    fileInput.value = '';
  });

  chooseBtn.addEventListener('click', ()=> fileInput.click());
  replaceBtn.addEventListener('click', ()=> fileInput.click());

  const readAB = (f)=> new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsArrayBuffer(f);});

  function getProfile(){
    // 返回 {dpi, quality}
    if(level.value==='light') return {dpi:150, quality:0.9};
    if(level.value==='strong') return {dpi:90, quality:0.6};
    return {dpi:110, quality:0.75}; // balanced
  }

  async function compressPDF(){
    if(!file){ alert(window.__i18n__?.t('tool.compress.errors.no_pdf') || 'Please add a PDF to compress.'); return; }
    runMsg.classList.remove('hidden'); runBtn.disabled=true;

    const { PDFDocument } = PDFLib;
    const srcBytes = await readAB(file);
    const loadingTask = pdfjsLib.getDocument({ data: srcBytes });
    const pdf = await loadingTask.promise;

    const out = await PDFDocument.create();
    if(!removeMeta.checked){
      out.setTitle(file.name.replace(/\.pdf$/i,''));
      out.setProducer('DocPDFHub'); out.setCreator('DocPDFHub');
      out.setCreationDate(new Date()); out.setModificationDate(new Date());
    }

    const {dpi, quality} = getProfile();

    for(let p=1;p<=pdf.numPages;p++){
      const page = await pdf.getPage(p);
      const vp = page.getViewport({ scale: dpi/72 });
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1, Math.floor(vp.width));
      canvas.height = Math.max(1, Math.floor(vp.height));
      const ctx = canvas.getContext('2d', { alpha: false, willReadFrequently: false });
      await page.render({ canvasContext: ctx, viewport: vp }).promise;

      // JPEG 压缩
      const dataUrl = canvas.toDataURL('image/jpeg', quality);
      const jpgBytes = await (await fetch(dataUrl)).arrayBuffer();
      const jpg = await out.embedJpg(jpgBytes);

      const pageOut = out.addPage([vp.width, vp.height]);
      pageOut.drawImage(jpg, { x:0, y:0, width: vp.width, height: vp.height });
    }

    const outBytes = await out.save({ useObjectStreams: true, updateMetadata: true });
    const blob = new Blob([outBytes], {type:'application/pdf'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (file.name.replace(/\.pdf$/i,'') + '-compressed.pdf');
    a.click();
    URL.revokeObjectURL(a.href);

    runMsg.classList.add('hidden'); runBtn.disabled=false;
    alert(window.__i18n__?.t('tool.compress.result.title') || 'Compression complete');
  }

  runBtn.addEventListener('click', compressPDF);
  </script>
</body>
</html>
