<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>

  <!-- 由 i18n.js 接管写入 -->
  <title data-i18n-doc-title="tool.tojpg.ogTitle">PDF to JPG — DocPDFHub</title>
  <meta name="description" content="Turn every page into a high-quality JPEG — local and private." data-i18n-meta="tool.tojpg.ogDesc"/>

  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css"/>
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet"/>

  <!-- libs -->
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- i18n -->
  <script src="/js/i18n.js" defer></script>

  <style>
    .gradient{background:linear-gradient(90deg,#d53369 0%,#daae51 100%)}
    .dropzone{border:2px dashed #e5e7eb;}
    .drop-active{outline:2px dashed #ec4899; outline-offset:6px; background:#fff7fb}
  </style>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#ec4899">
  <link rel="canonical" href="https://yourdomain.com/PAGE_PATH">
  <link rel="alternate" href="https://yourdomain.com/PAGE_PATH" hreflang="x-default">
  <link rel="alternate" href="https://yourdomain.com/PAGE_PATH" hreflang="en">
  <link rel="alternate" href="https://yourdomain.com/zh/PAGE_PATH" hreflang="zh">

</head>
<body class="text-gray-900 bg-gray-50" style="font-family:'Source Sans Pro',sans-serif;">

  <!-- Nav -->
  <nav class="fixed w-full z-30 top-0 bg-white shadow">
    <div class="w-full max-w-6xl mx-auto flex items-center justify-between px-4 py-3">
      <a class="text-pink-600 font-extrabold text-2xl" href="/"><span data-i18n="common.brand">DocPDFHub</span></a>
      <div class="hidden md:flex items-center space-x-6 text-sm">
        <a href="/" class="text-gray-700 hover:text-pink-600" data-i18n="nav.home">Home</a>
        <a href="/tools/pdf-merge.html" class="text-gray-700 hover:text-pink-600" data-i18n="nav.merge">Merge PDF</a>
        <a href="/tools/pdf-split.html" class="text-gray-700 hover:text-pink-600" data-i18n="nav.split">Split PDF</a>
        <a href="/tools/pdf-compress.html" class="text-gray-700 hover:text-pink-600" data-i18n="nav.compress">Compress PDF</a>
        <a href="/tools/pdf-to-jpg.html" class="text-gray-900 font-semibold" data-i18n="nav.tojpg">PDF to JPG</a>
        <div class="flex items-center space-x-2">
          <button data-lang-btn="en" class="px-2 py-1 rounded hover:bg-gray-100">EN</button>
          <span class="text-gray-300">|</span>
          <button data-lang-btn="zh" class="px-2 py-1 rounded hover:bg-gray-100">中文</button>
        </div>
      </div>
      <!-- 移动端语言按钮（简化） -->
      <div class="md:hidden flex items-center space-x-2">
        <button data-lang-btn="en" class="px-2 py-1 rounded hover:bg-gray-100">EN</button>
        <button data-lang-btn="zh" class="px-2 py-1 rounded hover:bg-gray-100">中文</button>
      </div>
    </div>
  </nav>
  <div class="pt-20"></div>

  <!-- Hero -->
  <header class="gradient text-white pt-12 pb-10">
    <div class="max-w-6xl mx-auto px-4">
      <p class="uppercase tracking-widest opacity-90 text-sm" data-i18n="home.hero_kicker">PDF TOOLS</p>
      <h1 class="text-4xl md:text-5xl font-extrabold mt-2" data-i18n="tool.tojpg.title">PDF to JPG</h1>
      <p class="text-white text-opacity-90 mt-2 md:w-3/4" data-i18n="tool.tojpg.subtitle">
        Turn every page into a high-quality JPEG — local and private.
      </p>
      <p class="mt-3 text-sm text-white text-opacity-80" data-i18n="common.100_local">100% local in your browser • No upload</p>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-10">
    <div id="dropZone" class="bg-white border rounded-xl p-6 shadow-sm">
      <div class="text-center">
        <h2 class="text-xl font-bold" data-i18n="tool.tojpg.drop.title">Drop a PDF to convert</h2>
        <p class="text-gray-600 mt-1" data-i18n="tool.tojpg.drop.hint">You’ll get one JPEG per page.</p>

        <!-- 拖拽 + 点击上传 -->
        <label for="fileInput" class="block mt-4 p-6 border rounded-xl dropzone cursor-pointer">
          <div class="font-semibold" data-i18n="uploader.title">Drop files here or click to select</div>
          <div class="text-xs text-gray-500 mt-1" data-i18n="uploader.hint">Max 100MB each. Your files never leave your device.</div>
          <input id="fileInput" type="file" accept="application/pdf" class="sr-only"/>
        </label>

        <div class="mt-3">
          <button id="chooseBtn" class="bg-pink-600 text-white font-semibold rounded-full py-2 px-5 hover:bg-pink-700"
            data-i18n="tool.tojpg.drop.button">Select PDF</button>
          <div class="text-xs text-gray-500 mt-2" data-i18n="common.or_drop">or drag & drop</div>
        </div>
      </div>

      <!-- 已选择文件信息 -->
      <div id="fileInfo" class="mt-6 hidden">
        <div class="flex items-center justify-between">
          <div>
            <div id="fileName" class="font-medium"></div>
            <div id="fileSize" class="text-xs text-gray-500"></div>
          </div>
          <button id="replaceBtn" class="text-sm px-3 py-1 rounded border hover:bg-gray-50" data-i18n="tool.tojpg.options.add_more">Replace file</button>
        </div>

        <!-- 选项 -->
        <div class="grid md:grid-cols-4 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="tool.tojpg.options.dpi_label">Output quality (DPI)</label>
            <input id="dpi" type="number" class="w-full border rounded px-3 py-2" min="72" max="600" step="1" value="150"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="tool.tojpg.options.jpeg_label">JPEG quality</label>
            <input id="quality" type="number" class="w-full border rounded px-3 py-2" min="10" max="100" step="1" value="85"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="tool.tojpg.options.range_label">Pages (optional)</label>
            <input id="range" class="w-full border rounded px-3 py-2"
              placeholder="e.g. 1-3,5" data-i18n-placeholder="tool.tojpg.options.range_placeholder"/>
          </div>
          <label class="flex items-center space-x-2 mt-6 md:mt-0">
            <input id="bg" type="checkbox" class="form-checkbox h-4 w-4"/>
            <span class="text-sm" data-i18n="tool.tojpg.options.bg">Transparent background (if possible)</span>
          </label>
        </div>

        <!-- 运行 -->
        <div class="mt-6">
          <button id="runBtn" class="bg-pink-600 text-white font-bold rounded-full py-2.5 px-6" data-i18n="tool.tojpg.actions.convert">Convert to JPG</button>
          <p id="runMsg" class="mt-2 text-sm text-gray-500 hidden">
            <span data-i18n="tool.tojpg.running.status">Converting to JPG…</span>
            <span class="ml-1" data-i18n="tool.tojpg.running.tip">Rendering pages locally for best privacy.</span>
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="py-8 border-t text-center text-sm text-gray-500">
    <div class="max-w-6xl mx-auto px-4">
      <div data-i18n="footer.tagline">Free & private PDF tools in your browser.</div>
    </div>
  </footer>

  <script>
    // pdf.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

    // 语言初始化（默认英文）
    document.addEventListener('DOMContentLoaded', () => {
      const lang = localStorage.getItem('lang') || 'en';
      window.__i18n__?.setLang(lang);
    });
    document.querySelectorAll('[data-lang-btn]').forEach(btn=>{
      btn.addEventListener('click', ()=> window.__i18n__?.setLang(btn.getAttribute('data-lang-btn')));
    });

    // 工具 DOM
    const $ = s => document.querySelector(s);
    const dropZone = $('#dropZone');
    const fileInput = $('#fileInput');
    const chooseBtn = $('#chooseBtn');
    const replaceBtn = $('#replaceBtn');
    const fileInfo = $('#fileInfo');
    const fileName = $('#fileName');
    const fileSize = $('#fileSize');
    const dpiInput = $('#dpi');
    const qualityInput = $('#quality');
    const rangeInput = $('#range');
    const bg = $('#bg');
    const runBtn = $('#runBtn');
    const runMsg = $('#runMsg');

    // 选择器里那个 label.dropzone 也做拖拽态
    const dropLabel = document.querySelector('label[for="fileInput"]');

    let file = null;

    const fmtBytes = (n)=>{
      const u=['B','KB','MB','GB']; let i=0;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return (n<10 && i ? n.toFixed(1):Math.round(n)) + ' ' + u[i];
    };

    function showInfo(){
      fileInfo.classList.toggle('hidden', !file);
      if(file){
        fileName.textContent = file.name;
        fileSize.textContent = fmtBytes(file.size);
      }
    }

    // 拖拽高亮（外层与 label 内层统一处理）
    ['dragenter','dragover'].forEach(evt=>{
      (dropZone || document).addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        dropZone?.classList.add('drop-active');
        dropLabel?.classList.add('drop-active');
      });
    });
    ['dragleave','drop'].forEach(evt=>{
      (dropZone || document).addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        dropZone?.classList.remove('drop-active');
        dropLabel?.classList.remove('drop-active');
      });
    });

    // 放下文件
    dropZone.addEventListener('drop', (e)=>{
      const fs = Array.from(e.dataTransfer.files||[]).filter(f=>/\.pdf$/i.test(f.name));
      if (fs[0]){ file = fs[0]; showInfo(); }
    });

    // 选择文件
    fileInput.addEventListener('change', ()=>{
      const fs = Array.from(fileInput.files||[]).filter(f=>/\.pdf$/i.test(f.name));
      if (fs[0]){ file = fs[0]; showInfo(); }
      fileInput.value = ''; // 允许重复选择同一文件
    });

    document.getElementById('chooseBtn').addEventListener('click', ()=> fileInput.click());
    document.getElementById('replaceBtn').addEventListener('click', ()=> fileInput.click());

    // 工具函数
    const readAB = (f)=> new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.onerror=rej;
      r.readAsArrayBuffer(f);
    });

    function parseRanges(str, max){
      if(!str) return null;
      const out = new Set();
      str.split(',').map(s=>s.trim()).filter(Boolean).forEach(part=>{
        const m = part.match(/^(\d+)-(\d+)$/);
        if(m){
          let a=+m[1], b=+m[2]; if(a>b)[a,b]=[b,a];
          for(let i=a;i<=b;i++) if(i>=1&&i<=max) out.add(i);
        }else{
          const n=+part; if(n>=1 && n<=max) out.add(n);
        }
      });
      return Array.from(out).sort((a,b)=>a-b);
    }

    async function convertToJPG(){
      const t = (k, fb)=> (window.__i18n__?.t(k) || fb);

      if(!file){
        alert(t('tool.tojpg.errors.no_pdf', 'Please add a PDF to convert.'));
        return;
      }
      runMsg.classList.remove('hidden'); runBtn.disabled = true;

      try{
        const srcBytes = await readAB(file);
        const pdf = await pdfjsLib.getDocument({ data: srcBytes }).promise;

        const dpi = Math.max(72, Math.min(600, parseInt(dpiInput.value||150,10)));
        const quality = Math.max(0.1, Math.min(1, (parseInt(qualityInput.value||85,10)/100)));
        const pagesWanted = rangeInput.value ? parseRanges(rangeInput.value, pdf.numPages) : null;

        const zip = new JSZip();
        let count = 0;

        for(let p=1; p<=pdf.numPages; p++){
          if(pagesWanted && !pagesWanted.includes(p)) continue;

          const page = await pdf.getPage(p);
          const vp = page.getViewport({ scale: dpi/72 });

          const canvas = document.createElement('canvas');
          canvas.width = Math.max(1, Math.floor(vp.width));
          canvas.height = Math.max(1, Math.floor(vp.height));

          const ctx = canvas.getContext('2d', { alpha: !!bg.checked });
          await page.render({
            canvasContext: ctx,
            viewport: vp,
            background: bg.checked ? 'rgba(0,0,0,0)' : '#ffffff'
          }).promise;

          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          const bin = atob(dataUrl.split(',')[1]);
          const bytes = new Uint8Array(bin.length);
          for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);

          zip.file(`page-${p}.jpg`, bytes, {binary:true});
          count++;
        }

        if(count===0){
          alert(t('tool.tojpg.errors.no_pages', 'No pages selected.'));
          return;
        }

        const blob = await zip.generateAsync({type:'blob'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (file.name.replace(/\.pdf$/i,'') + '-images.zip');
        a.click();
        URL.revokeObjectURL(a.href);

        alert(t('tool.tojpg.result.title', 'Conversion complete'));
      }catch(err){
        console.error(err);
        alert(t('tool.tojpg.errors.fail', 'Failed to convert. Please try another file.'));
      }finally{
        runMsg.classList.add('hidden'); runBtn.disabled = false;
      }
    }

    document.getElementById('runBtn').addEventListener('click', convertToJPG);
  </script>
</body>
</html>

